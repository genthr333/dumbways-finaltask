name: build and deploy babackend

on:
  push:
    branches: [ "production" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: docker build -t ${{ secrets.PROD_DOCKER_SERVER }}/be-dumbmerch:production .

      - name: Push to Private Registry
        run: docker push ${{ secrets.PROD_DOCKER_SERVER }}/be-dumbmerch:production

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: SSH and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD.SERVER_IP }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: 6969
          script: |
            docker pull ${{ secrets.PROD_DOCKER_SERVER }}/be-dumbmerch:production
            docker stop be-production || true
            docker rm be-production || true
            docker run -d --name be-production \
              --network bridge \
              -p 5000:5000 \
              -e SECRET_KEY="${{ secrets.PROD_SECRET_KEY }}" \
              -e PATH_FILE="${{ secrets.PROD_PATH_FILE }}" \
              -e DB_HOST="${{ secrets.PROD_DB_HOST }}" \
              -e DB_USER="${{ secrets.PROD_DB_USER }}" \
              -e DB_PASSWORD="${{ secrets.PROD_DB_PASSWORD }}" \
              -e DB_NAME="${{ secrets.PROD_DB_NAME }}" \
              -e DB_PORT="5432" \
              -e PORT="5000" \
              ${{ secrets.PROD_DOCKER_SERVER }}/be-dumbmerch:production
#test secret DOCKER_SERVER